我已为你整理了项目规划.md，并补全了部署细节、目录结构、技术栈建议等。你可以直接保存为文件使用：

```markdown
# 项目规划.md

## 一、部署方案（宝塔面板）
### 1.1 服务器要求
- **系统**：CentOS 7.9+ / Ubuntu 20.04+
- **环境**：
  - Nginx 1.22+
  - MySQL 8.0+
  - PHP 8.1（仅管理后台）
  - Node.js 18+（API系统）
  - Redis 7.0+（缓存/队列）
- **防火墙**：
  - 开放端口：80,443,3306,6379,自定义API端口

### 1.2 宝塔部署流程
```bash
# 1. 创建独立网站
# API系统：api.svr0.cn
# IP查询工具：ip.svr0.cn

# 2. 数据库初始化
# 执行 /docs/sql/init.sql

# 3. 配置伪静态
# Nginx规则见 /docs/nginx/
```

---

二、API系统（Node.js + Express）

2.1 目录结构

```
/api-system/
├── src/
│   ├── controllers/      # API控制器
│   ├── services/        
│   │   └── maxmind.js   # .mmdb数据库读取服务
│   ├── middleware/
│   │   ├── auth.js      # 密钥验证中间件
│   │   └── rate-limit.js
│   ├── models/          # 数据库模型
│   └── routes/
├── config/
│   ├── database.js
│   └── maxmind.mmdb     # 需定期更新
├── logs/
└── ecosystem.config.js  # PM2配置
```

2.2 管理后台（Laravel）

```
/admin-api/
├── app/
│   ├── Http/Controllers/
│   │   ├── ApiKeyController.php
│   │   └── LogController.php
│   └── Models/
├── resources/views/
├── routes/web.php
└── .env.example
```

2.3 核心功能详情

管理后台

API密钥开关
- 全局服务开关（影响所有密钥）
- 单密钥限制：
  - 每日调用上限（支持自定义）
  - QPS限制（支持突发流量缓冲）

API密钥管理

```sql
-- 密钥表结构
CREATE TABLE api_keys (
  id VARCHAR(36) PRIMARY KEY,
  key_name VARCHAR(64),
  allowed_origins JSON, -- 支持多域名
  rate_limit INT DEFAULT 1000,
  status ENUM('active','disabled'),
  created_at TIMESTAMP
);
```

API调用统计
- 实时图表（Chart.js）
- 导出CSV（支持按密钥/时间段筛选）

API调用日志

```sql
-- 日志表结构
CREATE TABLE api_logs (
  id BIGINT AUTO_INCREMENT,
  api_key VARCHAR(36),
  client_ip VARCHAR(45),
  query_ip VARCHAR(45),
  response_time INT,
  status_code SMALLINT,
  created_at TIMESTAMP
);
```

后台日志
- 登录日志：记录用户名/IP/UA/地理位置
- 操作日志：记录API密钥变更/系统配置修改

---

三、IP查询工具（Next.js重构）

3.1 目录结构

```
/ip-tool/
├── pages/
│   ├── api/             # 内部API
│   ├── user/
│   │   ├── login.tsx
│   │   └── dashboard.tsx
│   └── admin/
├── components/
│   ├── IPQueryWidget.tsx # 保留现有UI组件
│   └── Captcha.tsx
├── public/
│   └── assets/
├── styles/
└── .env.local
```

3.2 用户中心

用户注册/登录
- 支持邮箱注册
- 找回密码流程：
  1. 发送带时效的验证链接
  2. 重置密码需验证人机

API密钥
- 自动生成示例代码（cURL/PHP/Python/JavaScript）
- 密钥可见性控制（仅首次显示完整密钥）

登录日志
- 显示最近10次登录记录
- 异常登录邮件提醒（异地/新设备）

3.3 管理后台

系统配置
- 邮件设置：
  - 支持SMTP/邮件推送
  - 测试邮件发送功能
- 人机验证：
  - 集成Google reCAPTCHA v3
  - 国内用户自动切换为极验
- 全局API密钥：
  - 可设置默认密钥（用于未注册用户）
- 查询限制：
  - 未注册用户：每日20次
  - 注册用户：每日1000次（可自定义）

实时监控
- WebSocket实时显示：
  - 在线用户数
  - 当前QPS
  - 今日总查询量

用户管理
- 批量操作（启用/禁用/删除）
- 用户标签系统（VIP/内部测试）

查询日志
- 支持按IP/用户/时间范围搜索
- 敏感信息脱敏显示（如完整IP）

---

四、运维细节

4.1 数据库更新

```bash
# 自动更新maxmind数据库（每周日3点）
0 3 * * 0 wget -O /api-system/config/maxmind.mmdb "https://.../GeoLite2-City.mmdb.gz" && gunzip -f maxmind.mmdb.gz
```

4.2 备份策略
- 保留最近7天备份

4.3 安全加固
- API系统启用HTTPS强制跳转
- 管理后台IP白名单（可选）
- 敏感接口启用二次验证

4.4 性能优化
- API系统：
  - Redis缓存热点IP数据（TTL: 1小时）
  - 启用HTTP/2
- IP查询工具：
  - 前端启用SSR
  - 图片使用WebP格式

```
